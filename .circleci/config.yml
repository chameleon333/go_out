version: 2
jobs:
    build:
        # machine: true
        docker:
            - image: circleci/php:7.3-stretch-node-browsers
            - image: circleci/mysql:5.7

            # duskテスト用
            - image: circleci/node:7.10-browsers
            - image: selenium/standalone-chrome

        environment:
            - APP_DEBUG: true
            - APP_ENV: testing
            - APP_KEY: base64:XOrH3Y+mrgWbcanrysRacUeB65LqheafmfhJ2bI8nJ4=
            - DB_CONNECTION: circle_testing
            - MYSQL_ALLOW_EMPTY_PASSWORD: true

        steps:
            - run: git config --global core.quotepath false
            
            - checkout
            - setup_remote_docker

            - run:
                name: setup
                command: |
                    sudo apt update && sudo apt install -y mariadb-client libpng-dev libjpeg-dev zlib1g-dev
                    sudo docker-php-ext-configure gd --with-png-dir=/usr/include --with-jpeg-dir=/usr/include
                    sudo docker-php-ext-install zip pdo_mysql gd
                    sudo composer self-update

            - restore_cache:
                keys:
                    - composer-v1-{{ checksum "composer.lock" }}
                    - composer-v1-
            - run: composer install -n --prefer-dist
            - save_cache:
                key: composer-v1-{{ checksum "composer.lock" }}
                paths:
                    - vendor
            - restore_cache:
                keys:
                    - node-v1-{{ checksum "package-lock.json" }}
                    - node-v1-
            - run: npm install
            - save_cache:
                key: node-v1-{{ checksum "package-lock.json" }}
                paths:
                    - node_modules

            - run:
                name: Run unit test
                command: | 
                    php artisan migrate
                    ./vendor/bin/phpunit

            - run:
                name: Run Laravel Server
                command: php artisan serve
                background: true

            - run:
                name: Run browser
                command: docker run -d -p 4444:4444 selenium/standalone-chrome
            - run: 
                name: Run dusk
                command: | 
                    npm run production
                    cp .env.testing .env
                    php artisan dusk --env=circleci

            - store_artifacts:
                path: tests/Browser/screenshots/


workflows:
    version: 2
    build_test_and_deploy:
        jobs:
            - build:
                context: kousatu         
#             # - deplay:
#             #     requires:
#             #         - test